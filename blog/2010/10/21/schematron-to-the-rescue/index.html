
<!DOCTYPE html>
<!--[if IEMobile 7 ]><html class="no-js iem7"><![endif]-->
<!--[if lt IE 9]><html class="no-js lte-ie8"><![endif]-->
<!--[if (gt IE 8)|(gt IEMobile 7)|!(IEMobile)|!(IE)]><!--><html class="no-js" lang="en"><!--<![endif]-->
<head>
  <meta charset="utf-8">
  <title>Schematron to the rescue! - Marcin bloguje</title>
  <meta name="author" content="Marcin Cylke">

  
  <meta name="description" content="In an ideal world all the standards fit well into their places. It is sufficient to use just one serious standard, because all the problems can be &hellip;">
  

  <!-- http://t.co/dKP3o1e -->
  <meta name="HandheldFriendly" content="True">
  <meta name="MobileOptimized" content="320">
  <meta name="viewport" content="width=device-width, initial-scale=1">

  
  <link rel="canonical" href="http://zygm0nt.github.com/blog/2010/10/21/schematron-to-the-rescue/">
  <link href="/favicon.png" rel="icon">
  <link href="/stylesheets/screen.css" media="screen, projection" rel="stylesheet" type="text/css">
  <script src="/javascripts/modernizr-2.0.js"></script>
  <script src="/javascripts/ender.js"></script>
  <script src="/javascripts/octopress.js" type="text/javascript"></script>
  <link href="/atom.xml" rel="alternate" title="Marcin bloguje" type="application/atom+xml">
  <link href='http://fonts.googleapis.com/css?family=Lato:400,700,400italic,700italic' rel='stylesheet' type='text/css'>
  <!--Fonts from Google"s Web font directory at http://google.com/webfonts -->
<link href="http://fonts.googleapis.com/css?family=PT+Serif:regular,italic,bold,bolditalic" rel="stylesheet" type="text/css">
<link href="http://fonts.googleapis.com/css?family=PT+Sans:regular,italic,bold,bolditalic" rel="stylesheet" type="text/css">

  
  <script type="text/javascript">
    var _gaq = _gaq || [];
    _gaq.push(['_setAccount', 'UA-172194-10']);
    _gaq.push(['_trackPageview']);

    (function() {
      var ga = document.createElement('script'); ga.type = 'text/javascript'; ga.async = true;
      ga.src = ('https:' == document.location.protocol ? 'https://ssl' : 'http://www') + '.google-analytics.com/ga.js';
      var s = document.getElementsByTagName('script')[0]; s.parentNode.insertBefore(ga, s);
    })();
  </script>


</head>

<body   >
  <header role="banner"><hgroup>
  <div id="logo">
  	<div id="logoLeft">{</div>
  	<div id="logoText">mob</div>
  	<div id="logoRight">}</div>
  	<div class="clear"></div>
  </div>
  <h1><a href="/">Marcin bloguje</a></h1>
  
    <h2>.impressions.memos.tech.</h2>
  
  <div class="clear"></div>
</hgroup>

</header>
  <nav role="navigation"><ul class="subscription" data-subscription="rss">
  <li><a href="/atom.xml" rel="subscribe-rss" title="subscribe via RSS">RSS</a></li>
  
</ul>
  
<form action="http://google.com/search" method="get">
  <fieldset role="search">
    <input type="hidden" name="q" value="site:zygm0nt.github.com" />
    <input class="search" type="text" name="q" results="0" placeholder="Search"/>
  </fieldset>
</form>
  
<ul class="main-navigation">
  <li><a href="/">Blog</a></li>
  <li><a href="/blog/archives">Archives</a></li>
</ul>

</nav>
  <div id="main">
    <div id="content">
      <div>
<article class="hentry" role="article">
  
  <header>
    
      
        <h1 class="entry-title">Schematron to the Rescue!</h1>
      
    
    
      <p class="meta">
        








  


<time datetime="2010-10-21T10:40:37+02:00" pubdate data-updated="true">Oct 21<span>st</span>, 2010</time>
        
      </p>
    
  </header>


<div class="entry-content"><div class='post'>
<table border="0">
<tr><td>
<p>In an ideal world all the standards fit well into their places. It is sufficient to use just one serious standard, because all the problems can be solved with it - the standardization processes is there for some reason. But that happens only in ideal
world, which we&#8217;re not living in. </p></td> <td><img src="http://blog.innovative-labs.com/blog/simpson_schematron.png" width="100"/>
</td></tr></table>

<p>In ideal world, when dealing with XML instances you&#8217;d be more than fulfilled using XML Schema, or RelaxNG, or any other simple xml formal  definition language to declare your data structure. With that you get rigid rules as to how XML documents should look like. There doesn&#8217;t seem to be much space to deviate from specs. Well, in fact there is.</p>

<EXCERPT/>

<p>The main problem of XML, aside its verbosity, is the inability to create concise rules for the input or output document as a whole. Perhaps it&#8217;s a nice feature, because XML Schema should only be used to describe a data structure, not to infer business rules on it. Perhaps not. Nevertheless it&#8217;s not what I needed in one of the projects I&#8217;ve worked on.</p>

<p>My need was to actually check the business validity of such documents. This was used in a Web Service environment, a pretty stupid WS, which sole role was to fetch data from database and pack it into appropriate XML structures. Errors might occur in database&#8217;s views or in WS - as usual. They might be data multiplication or appearance of some elements while they shouldn&#8217;t. Resulting documents were correctly validated with the xml schema, but the result was simply wrong from the business point of view.</p>

<p>What I needed an XML formalization language, an ability to write rules that would assert some rules, report on not meeting stated rules. I was in need of a tool to write business rules to tame such XML entities.</p>

<p>The simplest way I found to solve this was to use <a href="http://www.schematron.com/">Schematron!</a> - &#8220;a language for making assertions about patterns found in XML documents&#8221;. This neat tool is a set of XSL templates, that you use in conjunction with a rule set on documents to check. As a result of the check you get another XML document with test assertions - whether failed or succeeded.</p>

<p>With Schematron you write a set of rules you expect the document to assert, than you use Schematron XSL template to produce XSL rules specific for your case. Now you only need to use newly generated XSL rules template on your XML document to check rules compliance. Easy, if not, check the diagram below.</p>


<img src="http://blog.innovative-labs.com/blog/schematron_flow.png"
width="600"/>

<h2>How does it look?</h2>

The rules&#8217; file may look like this:

<pre class="brush: xml">
<?xml version="1.0" encoding="iso-8859-1"?>
<iso:schema    xmlns="http://purl.oclc.org/dsdl/schematron" 
           xmlns:iso="http://purl.oclc.org/dsdl/schematron" 
           xmlns:sch="http://www.ascc.net/xml/schematron"
           xmlns:dp ="http://www.dpawson.co.uk/ns#"
           xmlns:pc="http://example.com/pc/type"
           queryBinding='xslt2'
           schemaVersion="ISO19757-3">
  <iso:title>TouK Schematron test harness</iso:title>

  <iso:ns prefix="pc" uri="http://example.com/pc/types" />  


<iso:pattern id="pc.getMigrationOffers">
  <iso:title>checking GetMigrationOffers</iso:title>
  <iso:rule context="pc:getMigrationOffersResponse">
    <iso:report test="true()">Report date.<iso:value-of select="current-dateTime()"/></iso:report>
    <iso:assert test="count(//@offerId[. = current()/@offerId]) = 1" >Unique offers allowed.</iso:assert>
    <iso:assert test="count(//@asb) = 1">Each offer has to have an @abc attribute </iso:assert>
  </iso:rule>
  <iso:rule context="pc:offer">
    <iso:assert test="count(pc:tariff) = 1">Each offer has to have a tariff</iso:assert>
    <iso:assert test="count(pc:offerPromotion) = 1">Each offer has to have a promotion</iso:assert>
  </iso:rule>
</iso:pattern>

<iso:pattern id="pc.getAllPhones">
  <iso:title>checking GetAllPhones</iso:title>
  <iso:rule context="pc:tac">
    <iso:assert test="count(parent::node()/pc:tac[. = current()]) = 1">
        TACs should be unique. TAC: <iso:value-of select="."/>, 
        handsetId: <iso:value-of select="parent::node()/@handsetId"/>
        offerId: <iso:value-of select="parent::node()/@offerId"/>
    </iso:assert>
  </iso:rule>
</iso:pattern>

</iso:schema>
</pre>

<p>Here we see two rules, one named <b>getMigrationOffers</b> and the other <b>getAllPhones</b>. The rules - mainly their asserts seem pretty self explanatory, but for the sake of completeness I&#8217;ll describe the rules for <b>getAllPhones</b>.</p>

<p>There is one rule, which checks the uniqueness of <b>tac</b> elements. This rule tries to ensure that each handset should have a list of unique tac elements as its children. However there may appear tac elements of the same value in different handset elements.</p>

<p>Given an input XML in the form of:</p>

<pre class="brush: xml">
<soap:Envelope xmlns:soap="http://www.w3.org/2003/05/soap-envelope">
   <soap:Body>
      <getAllPhonesResponse xmlns="http://example.com/pc/types">
         <handset endDate="2010-12-31T00:00:00.000+01:00" grossPrice="399" handsetId="95" isAllPhones="true" isPhone="true" manufacturer="SonyEricsson " materialSymbol="TE-SE-XW980-NS1-00" name=" Sony Ericsson W980, Open Market 48H" netPrice="327.04" offerId="103021" priceListId="5912" startDate="2010-03-22T00:00:00.000+01:00">
            <tac>12028006</tac>
            <tac>20070705</tac>
            <tac>35535302</tac>
            <tac>01216100</tac>
            <tac>01216100</tac>
         </handset>
         <handset endDate="2010-12-31T00:00:00.000+01:00" grossPrice="399" handsetId="95" isAllPhones="true" isPhone="true" manufacturer="SonyEricsson " materialSymbol="TE-SE-XW980-NS1-00" name=" Sony Ericsson W980, Open Market 48H" netPrice="327.04" offerId="103056" priceListId="5912" startDate="2010-03-22T00:00:00.000+01:00">
            <tac>12028006</tac>
            <tac>20070705</tac>
            <tac>35535302</tac>
            <tac>01216100</tac>
         </handset>
         <handset endDate="2010-12-31T00:00:00.000+01:00" grossPrice="399" handsetId="95" isAllPhones="true" isPhone="true" manufacturer="SonyEricsson " materialSymbol="TE-SE-XW980-NS1-00" name=" Sony Ericsson W980, Open Market 48H" netPrice="327.04" offerId="103032" priceListId="5912" startDate="2010-03-22T00:00:00.000+01:00">
            <tac>12028006</tac>
            <tac>20070705</tac>
            <tac>35535302</tac>
            <tac>01216100</tac>
         </handset>
       </getAllPhonesResponse>
   </soap:Body>
</soap:Envelope>
</pre>

And passing those two files through the processing pipeline you get a report:

<pre class="brush: xml">
<?xml version="1.0" encoding="UTF-8" standalone="yes"?>
<svrl:schematron-output xmlns:schold="http://www.ascc.net/xml/schematron"
                        xmlns:iso="http://purl.oclc.org/dsdl/schematron"
                        xmlns:saxon="http://saxon.sf.net/"
                        xmlns:pc="http://example.com/pc/types"
                        xmlns:xs="http://www.w3.org/2001/XMLSchema"
                        xmlns:svrl="http://purl.oclc.org/dsdl/svrl"
                        xmlns:xhtml="http://www.w3.org/1999/xhtml"
                        xmlns:xsd="http://www.w3.org/2001/XMLSchema"
                        title="TouK Schematron test harness"
                        schemaVersion="ISO19757-3">
    
   <svrl:ns-prefix-in-attribute-values uri="http://example.com/pc/types" prefix="pc"/>
   <svrl:active-pattern document="file:/tmp/schematron/getAllPhones.xml" id="pc.getMigrationOffers"
                        name="checking GetMigrationOffers"/>
   <svrl:active-pattern document="file:/tmp/schematron/getAllPhones.xml" id="pc.getAllPhones"
                        name="checking GetAllPhones"/>
   <svrl:fired-rule context="pc:tac"/>
   <svrl:fired-rule context="pc:tac"/>
   <svrl:fired-rule context="pc:tac"/>
   <svrl:fired-rule context="pc:tac"/>
   <svrl:failed-assert test="count(parent::node()/pc:tac[. = current()]) = 1"
                       location="/*:Envelope[namespace-uri()='http://www.w3.org/2003/05/soap-envelope'][1]/*:Body[namespace-uri()='http://www.w3.org/2003/05/soap-envelope'][1]/*:getAllPhonesResponse[namespace-uri()='http://example.com/pc/types'][1]/*:handset[namespace-uri()='http://example.com/pc/types'][1]/*:tac[namespace-uri()='http://example.com/pc/types'][4]">
      <svrl:text>
        TACs should be unique. TAC: 01216100, 
        handsetId: 95
        offerId: 103021</svrl:text>
   </svrl:failed-assert>
   <svrl:fired-rule context="pc:tac"/>
   <svrl:failed-assert test="count(parent::node()/pc:tac[. = current()]) = 1"
                       location="/*:Envelope[namespace-uri()='http://www.w3.org/2003/05/soap-envelope'][1]/*:Body[namespace-uri()='http://www.w3.org/2003/05/soap-envelope'][1]/*:getAllPhonesResponse[namespace-uri()='http://example.com/pc/types'][1]/*:handset[namespace-uri()='http://example.com/pc/types'][1]/*:tac[namespace-uri()='http://example.com/pc/types'][5]">
      <svrl:text>
        TACs should be unique. TAC: 01216100, 
        handsetId: 95
        offerId: 103021</svrl:text>
   </svrl:failed-assert>
   <svrl:fired-rule context="pc:tac"/>
   <svrl:fired-rule context="pc:tac"/>
   <svrl:fired-rule context="pc:tac"/>
   <svrl:fired-rule context="pc:tac"/>
[...]
</svrl:schematron-output>
</pre>

<p>After running the validation, the report presents us with the result. It shows that there are actually non-unique tacs. Unfortunately the rule itself is not so optimal, as it is executed for each tac node. The better case would be to create a rule operating only on groups of tacs - having a rule for each handset&#8217;s tacs would be much better.

<h2>Performance consideration</h2>

<p>As you may have seen, Schematron gives quite a potential, if it comes to rules building - maybe not the easiest to comprehend, since written with XPath, but good enough.</p>

<p>However, with all the XML processing involved in the process, it may take some considerable amount of time to execute such validations. For example, processing rules for file <b>getMigrationOffers.xml</b> takes about 2.296s - the file has 82 offer elements, which the rules operate on. But validating the other file, <b>getAllPhones.xml</b> takes 5.324s, with 3113 tac elements, and the rule iterating all of them.</p>

<p>This overhead is too much in most of the situations. That&#8217;s why this solution is rather not for use in normal execution pipeline - it would be unwise to put Schematron to check each request, thus entangle it into my Web Services normal flow.</p>

<p>What may be more desirable is to deploy a continuous integration server, with a project querying such Web Service and checking the rules in this manner.</p>

<h2>Conclusion</h2>

<p>So, what&#8217;s so great about having one XML generate another XML? Perhaps nothing, I think it would took just about a day to write some shell, python, &lt;other text processing tool&gt; that would perform equally (or even better). However, we loose technology homogeneity, and employ some other environments, not specific to our primary target platform, and that seems bad. Of course using some powerful text processing tool to impose the same rules might be much more efficient, thou less coherent.</p>

<p>What is your approach to such situations? Have you used Schematron or any other similar tool?</p>

<p><font size="-2">Code for this example is available on GitHub - <a
href="http://github.com/zygm0nt/schematron-example">http://github.com/zygm0nt/schematron-example</a>.</font></p></div>
</div>


  <footer>
    <p class="meta">
      
  

<span class="byline author vcard">Posted by <span class="fn">Marcin Cylke</span></span>

      








  


<time datetime="2010-10-21T10:40:37+02:00" pubdate data-updated="true">Oct 21<span>st</span>, 2010</time>
      

<span class="categories">
  
    <a class='category' href='/blog/categories/it/'>IT</a>, <a class='category' href='/blog/categories/ogólne/'>Ogólne</a>, <a class='category' href='/blog/categories/techblog/'>Techblog</a>, <a class='category' href='/blog/categories/touk/'>touk</a>
  
</span>


    </p>
    
      <div class="sharing">
  
  <a href="http://twitter.com/share" class="twitter-share-button" data-url="http://zygm0nt.github.com/blog/2010/10/21/schematron-to-the-rescue/" data-via="zygm0nt" data-counturl="http://zygm0nt.github.com/blog/2010/10/21/schematron-to-the-rescue/" >Tweet</a>
  
  
  
</div>

    
    <p class="meta">
      
        <a class="basic-alignment left articlenav" href="/blog/2010/08/26/complex-flows-with-apache-camel/" title="Previous Post: Complex flows with Apache Camel">&laquo; Complex flows with Apache Camel</a>
      
      
        <a class="basic-alignment right articlenav" href="/blog/2010/11/06/best-pigsticking-ever/" title="Next Post: Best pigsticking, EVER!">Best pigsticking, EVER! &raquo;</a>
      
    </p>
  </footer>
</article>

</div>

<aside class="sidebar">
  
    <section>
  <h1>Recent Posts</h1>
  <ul id="recent_posts">
    
      <li class="post">
        <a href="/blog/2012/11/30/after-whug/">After WHUG meeting</a>
      </li>
    
      <li class="post">
        <a href="/blog/2012/11/26/whug-8-beyond-hadoop/">WHUG 8. Beyond Hadoop - checking other options</a>
      </li>
    
      <li class="post">
        <a href="/blog/2012/10/30/hadoop-ha/">Hadoop HA setup</a>
      </li>
    
      <li class="post">
        <a href="/blog/2012/10/18/raspberry-pi/">raspberry-pi</a>
      </li>
    
      <li class="post">
        <a href="/blog/2012/06/18/hadoop-for-enterprises/">Hadoop for Enterprises</a>
      </li>
    
  </ul>
</section>

<section>
  <h1>GitHub Repos</h1>
  <ul id="gh_repos">
    <li class="loading">Status updating...</li>
  </ul>
  
  <a href="https://github.com/zygm0nt">@zygm0nt</a> on GitHub
  
  <script type="text/javascript">
    $.domReady(function(){
        if (!window.jXHR){
            var jxhr = document.createElement('script');
            jxhr.type = 'text/javascript';
            jxhr.src = '/javascripts/libs/jXHR.js';
            var s = document.getElementsByTagName('script')[0];
            s.parentNode.insertBefore(jxhr, s);
        }

        github.showRepos({
            user: 'zygm0nt',
            count: 0,
            skip_forks: true,
            target: '#gh_repos'
        });
    });
  </script>
  <script src="/javascripts/github.js" type="text/javascript"> </script>
</section>


<section>
  <h1>Latest Tweets</h1>
  <ul id="tweets">
    <li class="loading">Status updating...</li>
  </ul>
  <script type="text/javascript">
    $.domReady(function(){
      getTwitterFeed("zygm0nt", 4, false);
    });
  </script>
  <script src="/javascripts/twitter.js" type="text/javascript"> </script>
  
    <a href="http://twitter.com/zygm0nt" class="twitter-follow-button" data-show-count="false">Follow @zygm0nt</a>
  
</section>





  
</aside>


    </div>
  </div>
  <footer role="contentinfo"><p>
  Copyright &copy; 2012 - Marcin Cylke -
  <span class="credit">Powered by <a href="http://octopress.org">Octopress</a></span>
</p>

</footer>
  

<script type="text/javascript">
      var disqus_shortname = 'marcinbloguje';
      
        
        var disqus_script = 'count.js';
      
    (function () {
      var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
      dsq.src = 'http://' + disqus_shortname + '.disqus.com/' + disqus_script;
      (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
    }());
</script>







  <script type="text/javascript">
    (function(){
      var twitterWidgets = document.createElement('script');
      twitterWidgets.type = 'text/javascript';
      twitterWidgets.async = true;
      twitterWidgets.src = 'http://platform.twitter.com/widgets.js';
      document.getElementsByTagName('head')[0].appendChild(twitterWidgets);
    })();
  </script>





</body>
</html>
